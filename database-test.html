<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Shared Database Test</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="test-results" class="space-y-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                <span>Running tests...</span>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Test Actions</h2>
            <div class="space-x-4">
                <button onclick="testGetCurrentWeek()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Test Get Current Week
                </button>
                <button onclick="testGetMenu()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    Test Get Menu
                </button>
                <button onclick="testGetAllMenus()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    Test Get All Menus
                </button>
                <button onclick="testSaveMenu()" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                    Test Save Menu
                </button>
            </div>
        </div>
    </div>

    <script>
        // Copy the SharedMenuDatabase class from the main app
        class SharedMenuDatabase {
            constructor() {
                this.sharedMenuUrl = 'https://raw.githubusercontent.com/typond/kantine-app/main/shared-menu.json';
            }
            
            async getCurrentWeekNumber() {
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const pastDaysOfYear = (now.getTime() - startOfYear.getTime()) / 86400000;
                return Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
            }
            
            async getMenu(weekNumber) {
                try {
                    console.log('üîç Checking shared menu data for week', weekNumber);
                    const response = await fetch(this.sharedMenuUrl + '?t=' + Date.now());
                    if (!response.ok) {
                        console.log('‚ö†Ô∏è Shared menu not available:', response.status);
                        return null;
                    }
                    
                    const sharedData = await response.json();
                    if (sharedData.menus && sharedData.menus[weekNumber]) {
                        console.log('‚úÖ Found shared menu for week', weekNumber);
                        return sharedData.menus[weekNumber].menu;
                    }
                    
                    console.log('‚ö†Ô∏è No shared menu found for week', weekNumber);
                    return null;
                } catch (error) {
                    console.log('‚ö†Ô∏è Error fetching shared menu:', error.message);
                    return null;
                }
            }
            
            async saveMenu(weekNumber, menuData) {
                try {
                    console.log('üíæ Saving menu to shared storage for week', weekNumber);
                    
                    const menuRecord = {
                        week: weekNumber,
                        menu: menuData,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem(`menu_week_${weekNumber}`, JSON.stringify(menuRecord));
                    
                    console.log('üìù Menu saved locally. To update shared storage:');
                    console.log('1. Go to the GitHub repository');
                    console.log('2. Edit shared-menu.json');
                    console.log('3. Add the menu data for week', weekNumber);
                    
                    return true;
                } catch (error) {
                    console.error('Error saving menu:', error);
                    return false;
                }
            }
            
            async getAllMenus() {
                try {
                    const response = await fetch(this.sharedMenuUrl + '?t=' + Date.now());
                    if (!response.ok) {
                        return [];
                    }
                    
                    const sharedData = await response.json();
                    if (sharedData.menus) {
                        return Object.keys(sharedData.menus).map(week => ({
                            week: parseInt(week),
                            menu: sharedData.menus[week].menu,
                            timestamp: sharedData.menus[week].timestamp
                        })).sort((a, b) => b.week - a.week);
                    }
                    
                    return [];
                } catch (error) {
                    console.error('Error retrieving all menus:', error);
                    return [];
                }
            }
        }
        
        const menuDB = new SharedMenuDatabase();
        
        function addTestResult(testName, success, message, data = null) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `p-4 rounded-lg ${success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
            
            let html = `
                <div class="flex items-center mb-2">
                    <span class="text-lg font-semibold ${success ? 'text-green-800' : 'text-red-800'}">${testName}</span>
                    <span class="ml-2 text-sm ${success ? 'text-green-600' : 'text-red-600'}">${success ? '‚úÖ PASS' : '‚ùå FAIL'}</span>
                </div>
                <p class="text-sm ${success ? 'text-green-700' : 'text-red-700'}">${message}</p>
            `;
            
            if (data) {
                html += `<pre class="mt-2 text-xs bg-gray-100 p-2 rounded overflow-auto max-h-32">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testGetCurrentWeek() {
            try {
                const week = await menuDB.getCurrentWeekNumber();
                addTestResult('Get Current Week', true, `Current week: ${week}`, { week });
            } catch (error) {
                addTestResult('Get Current Week', false, `Error: ${error.message}`);
            }
        }
        
        async function testGetMenu() {
            try {
                const week = await menuDB.getCurrentWeekNumber();
                const menu = await menuDB.getMenu(week);
                if (menu) {
                    addTestResult('Get Menu', true, `Found menu for week ${week}`, menu);
                } else {
                    addTestResult('Get Menu', false, `No menu found for week ${week}`);
                }
            } catch (error) {
                addTestResult('Get Menu', false, `Error: ${error.message}`);
            }
        }
        
        async function testGetAllMenus() {
            try {
                const menus = await menuDB.getAllMenus();
                addTestResult('Get All Menus', true, `Found ${menus.length} menus`, menus);
            } catch (error) {
                addTestResult('Get All Menus', false, `Error: ${error.message}`);
            }
        }
        
        async function testSaveMenu() {
            try {
                const week = await menuDB.getCurrentWeekNumber();
                const testMenu = {
                    "HUB 1": {
                        "Mandag": "Test dish from save test",
                        "Tirsdag": "Another test dish"
                    }
                };
                
                const result = await menuDB.saveMenu(week, testMenu);
                addTestResult('Save Menu', result, `Save result: ${result}`, testMenu);
            } catch (error) {
                addTestResult('Save Menu', false, `Error: ${error.message}`);
            }
        }
        
        // Run initial tests on page load
        window.addEventListener('load', async () => {
            document.getElementById('test-results').innerHTML = '';
            
            await testGetCurrentWeek();
            await testGetAllMenus();
            await testGetMenu();
        });
    </script>
</body>
</html>
