<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canteen Menu Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .highlight-dish {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3), 0 4px 6px -2px rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        .error-message {
            text-align: center;
            padding: 2rem;
            background-color: #fff;
            border: 1px solid #fee2e2;
            color: #b91c1c;
            border-radius: 0.75rem;
        }
        .day-dish {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .day-dish:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow-down {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-center justify-between pb-6 border-b-2 border-gray-100 mb-8 gap-4">
            <div class="flex items-center gap-4">
                <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=800&auto=format&fit=crop" alt="A bowl of healthy food" class="h-12 w-12 rounded-full object-cover">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Canteen Menu</h1>
                    <p class="text-gray-500">Your Weekly Dining Recommendations</p>
                </div>
            </div>
            <div id="current-week" class="text-right text-gray-500 text-sm md:text-base font-medium"></div>
            <button id="add-menu-btn" class="bg-white p-2 rounded-full text-gray-500 hover:text-emerald-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </header>

        <!-- Main controls -->
        <section id="controls-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
            <details open>
                <summary class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-lg font-bold text-gray-800">Filter Preferences</h2>
                    <svg class="w-6 h-6 text-gray-500 transition-transform arrow-down" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                </summary>
                <div class="mt-4 border-t pt-4">
                    <p class="text-gray-500 mb-4">Select, add, or remove keywords for your recommendations. Changes are saved automatically.</p>
                    <div id="keywords-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-x-4 gap-y-3">
                        <!-- Checkboxes will be dynamically inserted here -->
                    </div>
                    <div class="flex items-center gap-2 mt-6 border-t pt-4">
                        <input type="text" id="new-keyword-input" placeholder="Add new preference..." class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <button id="add-keyword-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Add</button>
                    </div>
                </div>
            </details>
        </section>

        <div class="text-center mb-8">
             <button id="process-btn" class="w-full sm:w-auto bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                Get Menu & Recommendations
            </button>
            <p id="api-limit-text" class="text-sm text-gray-500 mt-2"></p>
        </div>

        <!-- Menu Grid -->
        <main id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 hidden">
            <!-- Menu columns will be dynamically inserted here -->
        </main>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden justify-center items-center h-64">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-emerald-500"></div>
            <p id="loading-text" class="ml-4 text-gray-600">Asking Gemini to read the website...</p>
        </div>
        
        <!-- Error Message Container -->
        <div id="error-container" class="hidden"></div>

        <!-- Add Menu Modal -->
        <div id="add-menu-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full transform transition-all">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Tilføj Nyt Menukort</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modal-initial-view">
                    <p class="text-gray-600 mb-6">Start med at finde spisesteder i nærheden af dig for at tilføje et nyt menukort.</p>
                    <button id="find-nearby-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        Find i nærheden
                    </button>
                </div>
                <div id="modal-loading-view" class="hidden text-center py-8">
                     <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-emerald-500 mx-auto"></div>
                     <p id="modal-loading-text" class="mt-4 text-gray-600">Henter din position...</p>
                </div>
                <div id="modal-places-view" class="hidden">
                    <p class="text-gray-600 mb-4">Vælg et sted fra listen for at fortsætte.</p>
                    <div id="places-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Nearby places will be injected here -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const menuContainer = document.getElementById('menu-container');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorContainer = document.getElementById('error-container');
            const processBtn = document.getElementById('process-btn');
            const keywordsContainer = document.getElementById('keywords-container');
            const addKeywordBtn = document.getElementById('add-keyword-btn');
            const newKeywordInput = document.getElementById('new-keyword-input');
            const apiLimitText = document.getElementById('api-limit-text');
            const loadingText = document.getElementById('loading-text');

            // Modal elements
            const addMenuBtn = document.getElementById('add-menu-btn');
            const addMenuModal = document.getElementById('add-menu-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const findNearbyBtn = document.getElementById('find-nearby-btn');
            const modalInitialView = document.getElementById('modal-initial-view');
            const modalLoadingView = document.getElementById('modal-loading-view');
            const modalLoadingText = document.getElementById('modal-loading-text');
            const modalPlacesView = document.getElementById('modal-places-view');
            const placesList = document.getElementById('places-list');


            // --- State ---
            const GEMINI_API_KEY = "AIzaSyBLNBurd4sRjo5dwZF95B-gVYIg36bTvao";
            const API_CALL_LIMIT = 4;
            const defaultKeywords = ['burger', 'flæskesteg', 'thai', 'indian', 'karry', 'curry', 'bolognese', 'moussaka', 'gyudon', 'bao', 'spidsbryst', 'oksekød', 'okse', 'fisk'];
            let keywords = [];
            let parsedMenuData = null; // In-memory cache for the session

            // --- Cookie & Cache Functions ---
            function saveCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                let expires = "expires="+ d.toUTCString();
                document.cookie = name + "=" + JSON.stringify(value) + ";" + expires + ";path=/;SameSite=Lax";
            }

            function loadCookie(name) {
                let cookieName = name + "=";
                let decodedCookie = decodeURIComponent(document.cookie);
                let ca = decodedCookie.split(';');
                for(let i = 0; i <ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1);
                    if (c.indexOf(cookieName) === 0) {
                        try {
                            return JSON.parse(c.substring(cookieName.length, c.length));
                        } catch (e) {
                            return null;
                        }
                    }
                }
                return null;
            }

            function getApiCount() {
                const today = new Date().toISOString().split('T')[0];
                const apiCountData = loadCookie('canteen_api_count');
                if (apiCountData && apiCountData.date === today) return apiCountData.count;
                return 0;
            }

            function incrementApiCount() {
                const today = new Date().toISOString().split('T')[0];
                let count = getApiCount();
                count++;
                saveCookie('canteen_api_count', { date: today, count: count }, 1);
                updateApiLimitText();
            }
            
            function updateApiLimitText() {
                const count = getApiCount();
                const remaining = API_CALL_LIMIT - count;
                apiLimitText.textContent = `You have ${remaining} recommendations left today.`;
                if (remaining <= 0) {
                    processBtn.disabled = true;
                    apiLimitText.textContent = "You have reached your daily limit for recommendations.";
                } else {
                    processBtn.disabled = false;
                }
            }

            function saveMenuToCache(menuData) {
                const today = new Date().toISOString().split('T')[0];
                const cacheData = { date: today, menu: menuData };
                localStorage.setItem('canteen_menu_cache', JSON.stringify(cacheData));
            }

            function loadMenuFromCache() {
                const today = new Date().toISOString().split('T')[0];
                const cachedData = localStorage.getItem('canteen_menu_cache');
                if (cachedData) {
                    try {
                        const parsed = JSON.parse(cachedData);
                        if (parsed.date === today) {
                            return parsed.menu;
                        }
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            function renderKeywords() {
                keywordsContainer.innerHTML = keywords.map(keyword => `<label class="flex items-center justify-between space-x-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer border border-transparent"><div class="flex items-center space-x-2"><input type="checkbox" value="${keyword}" class="keyword-checkbox h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" checked><span class="text-gray-700 capitalize">${keyword}</span></div><button class="delete-keyword-btn text-gray-400 hover:text-red-500" data-keyword="${keyword}" title="Delete keyword"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button></label>`).join('');
            }

            // --- Gemini API Functions ---
            async function callGemini(prompt, apiKey) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                
                let retries = 3;
                let delay = 1000; // Start with 1 second delay

                while (retries > 0) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                        // If the server is overloaded (503), throw an error to trigger a retry.
                        if (response.status === 503) {
                            throw new Error('Model is overloaded. Retrying...');
                        }

                        if (!response.ok) {
                            const errorBody = await response.text();
                            console.error("API Error Response:", errorBody);
                            throw new Error(`API request failed with status ${response.status}.`);
                        }
                        
                        const result = await response.json();
                        if (result.candidates?.[0]?.content?.parts?.[0]) {
                            let jsonString = result.candidates[0].content.parts[0].text;
                            jsonString = jsonString.replace(/```json\n/g, '').replace(/```/g, '');
                            return JSON.parse(jsonString); // Success, exit the loop
                        } else {
                            throw new Error("Invalid response structure from Gemini API.");
                        }
                    } catch (error) {
                        console.log(`Attempt failed: ${error.message}. Retries left: ${retries - 1}`);
                        retries--;
                        if (retries === 0) {
                            console.error("Error calling Gemini API after multiple retries:", error);
                            displayError(error.message);
                            return null;
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
                return null; // Should not be reached if all retries fail and throw an error
            }

            async function parseMenuWithGemini(siteHtml, apiKey) {
                const prompt = `You are a menu parsing assistant. Analyze the provided HTML and extract the weekly menu. Return a single JSON object with keys "HUB 1", "HUB 2", "HUB 3", and "Foodcore". For "HUB 1", "HUB 2", and "HUB 3", the value should be an object mapping each day ("Mandag" to "Fredag") to its dish. "HUB 1" is the first main column, "HUB 2" is the second, and "HUB 3" is the "Kays" menu. For "Foodcore", the value should be an object mapping each day to another object containing "Globetrotter" and "Homebound" dishes. Here is the HTML: --- ${siteHtml} ---`;
                return await callGemini(prompt, apiKey);
            }

            async function getRecommendationsFromGemini(menuData, activeKeywords, apiKey) {
                const prompt = `Given the following JSON menu: --- ${JSON.stringify(menuData)} --- And the user's food preferences in order of priority: --- ${activeKeywords} --- Return a JSON object mapping each day ("Mandag" to "Fredag") to the name of the recommended cafeteria. The recommendation should be the first dish found for a day that matches a keyword. If no match is found, the value should be "Any".`;
                return await callGemini(prompt, apiKey);
            }
            
            function displayError(message) {
                loadingSpinner.classList.add('hidden');
                errorContainer.innerHTML = `<div class="error-message"><h3 class="font-bold text-lg mb-2">An Error Occurred</h3><p>${message}</p></div>`;
                errorContainer.classList.remove('hidden');
            }
            
            function generateCalendarLink(day, cafeteria, dish) {
                const dayMap = { "Mandag": 1, "Tirsdag": 2, "Onsdag": 3, "Torsdag": 4, "Fredag": 5 };
                const targetDay = dayMap[day];
                if (typeof targetDay === 'undefined') return '#';
                const now = new Date();
                const today = now.getDay();
                let dayDifference = targetDay - today;
                if (dayDifference < 0) dayDifference += 7;
                const eventDate = new Date();
                eventDate.setDate(now.getDate() + dayDifference);
                const startTime = new Date(eventDate.setHours(11, 30, 0, 0));
                const endTime = new Date(eventDate.setHours(12, 0, 0, 0));
                const formatDate = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');
                const baseUrl = "https://www.google.com/calendar/render?action=TEMPLATE";
                const title = encodeURIComponent(`Frokost: ${cafeteria}`);
                const details = encodeURIComponent(`Dagens ret: ${dish}`);
                const location = encodeURIComponent("HUBNORDIC Kantine");
                const dates = `${formatDate(startTime)}/${formatDate(endTime)}`;
                return `${baseUrl}&text=${title}&dates=${dates}&details=${details}&location=${location}`;
            }

            function addNewMenuCard(placeName) {
                const newMenu = {
                    "Mandag": "AI-Generated Pizza",
                    "Tirsdag": "Robo-Tacos",
                    "Onsdag": "Synthesized Soup",
                    "Torsdag": "Neural Net Noodles",
                    "Fredag": "Cyborg's Choice Salad"
                };
                const daysOrder = ["Mandag", "Tirsdag", "Onsdag", "Torsdag", "Fredag"];

                const column = document.createElement('div');
                column.className = 'bg-white rounded-xl shadow-md overflow-hidden flex flex-col border-4 border-emerald-400'; // Highlight new card

                let headerHtml = `<div class="p-4 bg-gray-100 border-b border-gray-200"><h2 class="text-xl font-bold text-center text-gray-700">(Nyt) ${placeName}</h2></div>`;
                let dailyDishesHtml = '<div class="p-5 flex-grow">';

                for (const day of daysOrder) {
                    const dish = newMenu[day];
                    const cardClasses = `p-4 rounded-lg border-2 day-dish bg-white border-transparent`;
                    dailyDishesHtml += `<div class="${cardClasses}"><div class="flex justify-between items-center mb-2"><h3 class="font-semibold text-gray-800">${day}</h3></div><p class="text-gray-600">${dish}</p></div>`;
                }
                dailyDishesHtml += '</div>';
                column.innerHTML = headerHtml + dailyDishesHtml;

                if (menuContainer.classList.contains('hidden')) {
                    menuContainer.classList.remove('hidden');
                }
                menuContainer.prepend(column);
            }

            function renderMenu(menuData, recommendations) {
                loadingSpinner.classList.add('hidden');
                menuContainer.innerHTML = '';
                menuContainer.classList.remove('hidden');
                const cafeteriaOrder = ["HUB 1", "HUB 2", "HUB 3", "Foodcore"];
                const daysOrder = ["Mandag", "Tirsdag", "Onsdag", "Torsdag", "Fredag"];
                for (const cafeteria of cafeteriaOrder) {
                    const cafeteriaMenu = menuData[cafeteria];
                    if (!cafeteriaMenu) continue;
                    const column = document.createElement('div');
                    column.className = 'bg-white rounded-xl shadow-md overflow-hidden flex flex-col';
                    let headerHtml = `<div class="p-4 bg-gray-100 border-b border-gray-200"><h2 class="text-xl font-bold text-center text-gray-700">${cafeteria}</h2></div>`;
                    let dailyDishesHtml = '<div class="p-5 flex-grow">';
                    for (const day of daysOrder) {
                        const isRecommended = recommendations[day] === cafeteria;
                        const dishEntry = cafeteriaMenu[day];
                        if (!dishEntry) continue;
                        const cardClasses = `p-4 rounded-lg border-2 day-dish ${isRecommended ? 'highlight-dish' : 'bg-white border-transparent'}`;
                        let dishHtml = '';
                        let fullDishDescription = '';
                        if (typeof dishEntry === 'string') {
                            dishHtml = `<p class="text-gray-600">${dishEntry}</p>`;
                            fullDishDescription = dishEntry;
                        } else {
                            dishHtml = '<div>';
                            let dishParts = [];
                            for (const subKitchen in dishEntry) {
                                dishHtml += `<div class="mb-2 last:mb-0"><h4 class="font-medium text-gray-700">${subKitchen}</h4><p class="text-gray-600">${dishEntry[subKitchen]}</p></div>`;
                                dishParts.push(`${subKitchen}: ${dishEntry[subKitchen]}`);
                            }
                            dishHtml += '</div>';
                            fullDishDescription = dishParts.join(' / ');
                        }
                        const calendarLink = generateCalendarLink(day, cafeteria, fullDishDescription);
                        dailyDishesHtml += `<div class="${cardClasses}"><div class="flex justify-between items-center mb-2"><h3 class="font-semibold text-gray-800">${day}</h3><div class="flex items-center space-x-2">${isRecommended ? '<span class="text-xs font-bold bg-emerald-500 text-white py-1 px-2 rounded-full shadow">EAT HERE</span>' : ''}<a href="${calendarLink}" target="_blank" rel="noopener noreferrer" title="Add to Google Calendar" class="text-gray-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg></a></div></div>${dishHtml}</div>`;
                    }
                    dailyDishesHtml += '</div>';
                    column.innerHTML = headerHtml + dailyDishesHtml;
                    menuContainer.appendChild(column);
                }
            }
            
            async function fetchWebsiteContent() {
                const proxyUrl = 'https://corsproxy.io/?';
                const menuUrl = 'https://hubnordic.madkastel.dk/';
                try {
                    const response = await fetch(`${proxyUrl}${encodeURIComponent(menuUrl)}`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    return await response.text();
                } catch (error) {
                    console.error("Failed to fetch website content:", error);
                    displayError("Kunne ikke oprette forbindelse til Madkastel-webstedet. Det er muligvis midlertidigt nede.");
                    return null;
                }
            }

            function setCurrentWeek() {
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const pastDaysOfYear = (now.getTime() - startOfYear.getTime()) / 86400000;
                const weekNumber = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
                document.getElementById('current-week').textContent = `Uge ${weekNumber}`;
            }

            // --- Modal Logic ---
            function openModal() {
                addMenuModal.classList.remove('hidden');
            }

            function closeModal() {
                addMenuModal.classList.add('hidden');
                // Reset to initial view
                modalInitialView.classList.remove('hidden');
                modalLoadingView.classList.add('hidden');
                modalPlacesView.classList.add('hidden');
            }

            // --- Event Listeners ---
            addMenuBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);

            addMenuModal.addEventListener('click', (e) => {
                if (e.target === addMenuModal) {
                    closeModal();
                }
            });

            findNearbyBtn.addEventListener('click', () => {
                modalInitialView.classList.add('hidden');
                modalLoadingView.classList.remove('hidden');
                modalLoadingText.textContent = 'Henter din position...';

                if (!navigator.geolocation) {
                    modalLoadingText.textContent = 'Geolocation is not supported by your browser.';
                    // Maybe switch back to initial view after a delay
                    return;
                }

                const success = (position) => {
                    // Simulate API call to get nearby places
                    setTimeout(() => {
                        const mockPlaces = [
                            { name: 'Pizza Palace', address: '123 Main St' },
                            { name: 'Burger Barn', address: '456 Oak Ave' },
                            { name: 'Sushi Central', address: '789 Pine Ln' },
                            { name: 'Taco Town', address: '101 Maple Dr' },
                        ];

                        placesList.innerHTML = ''; // Clear previous list
                        mockPlaces.forEach(place => {
                            const placeElement = document.createElement('div');
                            placeElement.className = 'p-4 border rounded-lg hover:bg-gray-100 cursor-pointer';
                            placeElement.textContent = `${place.name} - ${place.address}`;
                            placeElement.dataset.placeName = place.name;
                            placesList.appendChild(placeElement);
                        });

                        modalLoadingView.classList.add('hidden');
                        modalPlacesView.classList.remove('hidden');
                    }, 1500); // Simulate network delay
                };

                const error = () => {
                    modalLoadingText.textContent = 'Unable to retrieve your location. Please allow location access.';
                     setTimeout(() => {
                        modalLoadingView.classList.add('hidden');
                        modalInitialView.classList.remove('hidden');
                    }, 3000);
                };

                navigator.geolocation.getCurrentPosition(success, error);
            });

            placesList.addEventListener('click', (e) => {
                const selectedPlace = e.target.closest('[data-place-name]');
                if (!selectedPlace) return;

                const placeName = selectedPlace.dataset.placeName;

                modalPlacesView.classList.add('hidden');
                modalLoadingView.classList.remove('hidden');
                modalLoadingText.textContent = `Menukortet fra "${placeName}" sendes til Gemini for analyse...`;

                // This is where the next step will be triggered from
                setTimeout(() => {
                    addNewMenuCard(placeName);
                    closeModal();
                }, 2500);
            });

            processBtn.addEventListener('click', async () => {
                const apiCallCount = getApiCount();
                if (apiCallCount >= API_CALL_LIMIT) {
                    displayError("You have reached your daily limit of 4 recommendations.");
                    return;
                }

                menuContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');

                const activeKeywords = Array.from(document.querySelectorAll('.keyword-checkbox:checked')).map(cb => cb.value).join(', ');
                if (!activeKeywords) {
                    displayError("Please select at least one food preference.");
                    loadingSpinner.classList.add('hidden');
                    return;
                }

                try {
                    parsedMenuData = loadMenuFromCache();

                    if (!parsedMenuData) {
                        loadingText.textContent = "Analyzing website menu (first time today)...";
                        const siteHtml = await fetchWebsiteContent();
                        if (!siteHtml) {
                            loadingSpinner.classList.add('hidden');
                            return;
                        }
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(siteHtml, 'text/html');
                        const menuContainerEl = doc.querySelector('.c-menu__content');
                        const relevantHtml = menuContainerEl ? menuContainerEl.innerHTML : siteHtml;
                        parsedMenuData = await parseMenuWithGemini(relevantHtml, GEMINI_API_KEY);
                        if (parsedMenuData) {
                            saveMenuToCache(parsedMenuData);
                        }
                    }

                    loadingText.textContent = "Getting your recommendations...";
                    const recommendations = await getRecommendationsFromGemini(parsedMenuData, activeKeywords, GEMINI_API_KEY);
                    
                    if (parsedMenuData && recommendations) {
                        incrementApiCount();
                        renderMenu(parsedMenuData, recommendations);
                    }
                } catch (error) {
                     console.error("Error in process:", error);
                     displayError(error.message);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            addKeywordBtn.addEventListener('click', () => {
                const newKeyword = newKeywordInput.value.trim().toLowerCase();
                if (newKeyword && !keywords.includes(newKeyword)) {
                    keywords.push(newKeyword);
                    saveCookie('canteen_keywords', keywords, 365);
                    renderKeywords();
                    newKeywordInput.value = '';
                }
            });

            newKeywordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addKeywordBtn.click();
                }
            });

            keywordsContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-keyword-btn');
                if (deleteBtn) {
                    const keywordToDelete = deleteBtn.dataset.keyword;
                    keywords = keywords.filter(k => k !== keywordToDelete);
                    saveCookie('canteen_keywords', keywords, 365);
                    renderKeywords();
                }
            });
            
            // --- Initial Setup ---
            const savedKeywords = loadCookie('canteen_keywords');
            keywords = Array.isArray(savedKeywords) && savedKeywords.length > 0 ? savedKeywords : defaultKeywords;
            
            renderKeywords();
            setCurrentWeek();
            updateApiLimitText();
        });
    </script>
</body>
</html>
